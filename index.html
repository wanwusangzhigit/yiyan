<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>班级积分管理</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft YaHei",sans-serif;background:#f2f6ff;color:#333}
    .container{max-width:1000px;margin:0 auto;background:#fff;min-height:100vh;display:flex;flex-direction:column}
    .header{background:linear-gradient(135deg,#3498db,#2c3e50);color:#fff;padding:30px 20px;text-align:center;position:relative}
    .header h1{font-size:2em;margin-bottom:10px}
    .logout-btn{position:absolute;right:20px;top:20px;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.5);color:#fff;padding:6px 14px;border-radius:6px;cursor:pointer}
    .login-section{padding:40px 20px;text-align:center}
    .login-form{max-width:400px;margin:0 auto}
    .form-group{margin-bottom:20px;text-align:left}
    .form-group label{display:block;margin-bottom:6px;font-weight:600}
    .form-group input{width:100%;padding:12px;border:2px solid #ccdaff;border-radius:8px;font-size:16px}
    .btn{padding:10px 24px;border:none;border-radius:8px;font-size:16px;cursor:pointer;transition:.3s}
    .btn-primary{background:#3498db;color:#fff}
    .btn-success{background:#2ecc71;color:#fff}
    .btn-danger{background:#e74c3c;color:#fff}
    .btn:hover{opacity:.9}
    .main-content{padding:20px;display:none;flex:1}
    .controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}
    .search-box{display:flex;gap:8px;flex:1;max-width:300px}
    .search-box input{flex:1;padding:10px;border:2px solid #ccdaff;border-radius:8px}
    .student-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px}
    .student-card{background:#f8faff;border:1px solid #e0ecff;border-radius:12px;padding:20px;position:relative}
    .student-name{font-size:1.1em;font-weight:600;margin-bottom:10px}
    .student-score{font-size:2em;text-align:center;margin:10px 0;color:#3498db}
    .score-controls{display:flex;gap:8px;margin-top:10px}
    .score-btn{flex:1;padding:8px;border:none;border-radius:6px;cursor:pointer;font-size:14px;color:#fff}
    .score-btn.add{background:#2ecc71}
    .score-btn.subtract{background:#e74c3c}
    .ranking-section{margin-top:30px;background:#f8faff;border-radius:12px;padding:20px}
    .ranking-list{list-style:none}
    .ranking-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #e0ecff}
    .rank-number{width:30px;height:30px;border-radius:50%;background:#3498db;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;margin-right:10px}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000}
    .modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:30px;border-radius:12px;width:90%;max-width:400px}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}
    .status-bar{position:fixed;top:20px;right:20px;background:#2ecc71;color:#fff;padding:12px 20px;border-radius:8px;transform:translateX(400px);transition:.3s}
    .status-bar.show{transform:translateX(0)}
    .status-bar.error{background:#e74c3c}
    .fade-in{animation:fadeIn .4s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @media(max-width:600px){.controls{flex-direction:column;align-items:stretch}.student-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🎯 班级积分管理</h1>
      <p>零成本 · GitHub同步 · 实时更新</p>
      <button class="logout-btn" id="logoutBtn" style="display:none">退出</button>
    </div>

    <!-- 登录 -->
    <div class="login-section" id="loginSec">
      <form class="login-form" id="loginForm">
        <div class="form-group">
          <label>教师密码</label>
          <input type="password" id="pwdInput" placeholder="请输入密码（如 1026）" required>
        </div>
        <button class="btn btn-primary">🔐 登录</button>
      </form>
    </div>

    <!-- 主界面 -->
    <div class="main-content" id="mainSec">
      <div class="controls">
        <div class="search-box">
          <input id="searchInput" placeholder="搜索姓名/学号">
          <button class="btn btn-primary" onclick="render()">搜索</button>
        </div>
        <div>
          <button class="btn btn-success" onclick="addStu()">➕ 添加学生</button>
          <button class="btn btn-primary" onclick="sync()">🔄 同步</button>
          <button class="btn btn-danger" onclick="resetAll()">重置全部</button>
        </div>
      </div>

      <div class="student-grid" id="grid"></div>

      <div class="ranking-section">
        <h3>🏆 排行榜</h3>
        <ol id="rankList"></ol>
      </div>
    </div>
  </div>

  <!-- 模态框 -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div id="modalBody"></div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="modalOk()">确认</button>
        <button class="btn" onclick="modalClose()" style="background:#95a5a6;color:#fff">取消</button>
      </div>
    </div>
  </div>

  <!-- 状态提示 -->
  <div class="status-bar" id="status"></div>

  <script>
    /* ====== 基础变量 ====== */
    let token='',repo='',students=[],logged=0,sha=null;

    /* ====== 编码/解码 ====== */
    function enc(str){return btoa(unescape(encodeURIComponent(str)))}
    function dec(b64){return decodeURIComponent(escape(atob(b64)))}

    /* ====== 登录（仅密码→Worker） ====== */
    document.getElementById('loginForm').addEventListener('submit',async(e)=>{
      e.preventDefault();
      const pwd=document.getElementById('pwdInput').value.trim();
      if(!pwd)return toast('请输入密码','error');
      try{
        const res=await fetch('https://val.api.wanwusangzhi.top',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({pwd})
        });
        const data=await res.json();
        if(!data.ok)return toast('密码错误','error');
        token=data.token; repo=data.repo;
        localStorage.setItem('tk',token); localStorage.setItem('rp',repo);
        logged=1; toggleSec(); await load(); toast('登录成功','success');
      }catch(err){toast('连接失败：'+err.message,'error')}
    });

    /* ====== 退出 ====== */
    document.getElementById('logoutBtn').onclick=()=>{
      if(!confirm('确定退出？'))return;
      logged=0; ['tk','rp'].forEach(k=>localStorage.removeItem(k));
      location.reload();
    };

    /* ====== 界面切换 ====== */
    function toggleSec(){
      document.getElementById('loginSec').style.display=logged?'none':'block';
      document.getElementById('mainSec').style.display=logged?'block':'none';
      document.getElementById('logoutBtn').style.display=logged?'block':'none';
    }

    /* ====== 加载数据 ====== */
    async function load(){
      try{
        const repoInfo=await(await fetch(`https://api.github.com/repos/${repo}`,{headers:{Authorization:`token ${token}`}})).json();
        const branch=repoInfo.default_branch||'main';
        const r=await fetch(`https://api.github.com/repos/${repo}/contents/points.json?ref=${branch}`,{headers:{Authorization:`token ${token}`}});
        if(r.ok){const j=await r.json(); students=JSON.parse(dec(j.content)).students||[]; sha=j.sha;}
        else if(r.status===404){students=[]; sha=null;}
        else throw new Error('加载失败');
        render(); rank(); stats();
      }catch(err){toast('加载失败：'+err.message,'error')}
    }

    /* ====== 保存数据 ====== */
    async function save(){
      const repoInfo=await(await fetch(`https://api.github.com/repos/${repo}`,{headers:{Authorization:`token ${token}`}})).json();
      const branch=repoInfo.default_branch||'main';
      let sha=null;
      const get=await fetch(`https://api.github.com/repos/${repo}/contents/points.json?ref=${branch}`,{headers:{Authorization:`token ${token}`}});
      if(get.ok)sha=(await get.json()).sha; else if(get.status!==404)throw new Error('获取SHA失败');
      const body={message:'update '+new Date().toLocaleString('zh-CN'), content:enc(JSON.stringify({students,updated:new Date().toISOString()},null,2)), branch, sha};
      const put=await fetch(`https://api.github.com/repos/${repo}/contents/points.json`,{method:'PUT', headers:{Authorization:`token ${token}`,'Content-Type':'application/json'}, body:JSON.stringify(body)});
      if(!put.ok)throw new Error('保存失败');
      sha=(await put.json()).content.sha;
    }

    /* ====== 渲染 ====== */
    function render(list=students){
      const g=document.getElementById('grid');
      g.innerHTML=list.map(s=>`
        <div class="student-card fade-in">
          <div class="student-name">${s.name}（${s.id}）</div>
          <div class="student-score">${s.score}</div>
          <div class="score-controls">
            <button class="score-btn add" onclick="chg('${s.id}',1)">+1</button>
            <button class="score-btn add" onclick="chg('${s.id}',5)">+5</button>
            <button class="score-btn subtract" onclick="chg('${s.id}',-1)">-1</button>
            <button class="score-btn subtract" onclick="chg('${s.id}',-5)">-5</button>
          </div>
          <div style="margin-top:10px;display:flex;gap:6px">
            <input type="number" id="c${s.id}" placeholder="自定义" style="flex:1;padding:6px;border:1px solid #ccdaff;border-radius:6px">
            <button class="btn btn-primary" style="padding:6px 10px;font-size:14px" onclick="setC('${s.id}')">设置</button>
            <button class="btn btn-danger" style="padding:6px 10px;font-size:14px" onclick="del('${s.id}')">删除</button>
          </div>
        </div>`).join('');
    }

    /* ====== 分数操作 ====== */
    window.chg=(id,d)=>{
      const s=students.find(x=>x.id===id);
      if(!s)return;
      s.score=Math.max(0,s.score+d); s.lastUp=new Date().toISOString();
      render(); rank(); stats(); sync();
      toast(`${s.name} ${d>0?'+':''}${d} 分`);
    };
    window.setC=id=>{
      const v=parseInt(document.getElementById('c'+id).value);
      if(isNaN(v))return toast('请输入数字','error');
      const s=students.find(x=>x.id===id);
      s.score=Math.max(0,v); s.lastUp=new Date().toISOString();
      document.getElementById('c'+id).value='';
      render(); rank(); stats(); sync();
      toast(`${s.name} 已设为 ${v} 分`);
    };
    window.del=id=>{
      const s=students.find(x=>x.id===id);
      if(!s||!confirm(`删除 ${s.name}？`))return;
      students=students.filter(x=>x.id!==id);
      render(); rank(); stats(); sync();
      toast('已删除');
    };

    /* ====== 添加学生 ====== */
    window.addStu=()=>{
      const name=prompt('姓名'); if(!name)return;
      const id=prompt('学号'); if(!id)return;
      if(students.some(x=>x.id===id))return toast('学号重复','error');
      students.push({id,name,score:0,created:new Date().toISOString(),lastUp:new Date().toISOString()});
      render(); rank(); stats(); sync();
      toast('已添加');
    };

    /* ====== 排行榜 ====== */
    function rank(){
      const r=document.getElementById('rankList');
      const arr=[...students].sort((a,b)=>b.score-a.score);
      r.innerHTML=arr.slice(0,10).map((s,i)=>`
        <li class="ranking-item">
          <div style="display:flex;align-items:center">
            <div class="rank-number">${i+1}</div>
            <div><div>${s.name}</div><div style="font-size:12px;color:#666">${s.id}</div></div>
          </div>
          <div style="font-weight:700;color:#3498db">${s.score} 分</div>
        </li>`).join('');
    }

    /* ====== 统计 ====== */
    function stats(){
      const t=students.length,avg=t?Math.round(students.reduce((a,b)=>a+b.score,0)/t):0,max=t?Math.max(...students.map(x=>x.score)):0,min=t?Math.min(...students.map(x=>x.score)):0;
      document.getElementById('grid').insertAdjacentHTML('afterbegin',`
        <div style="grid-column:1/-1;display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px">
          <div class="student-card" style="text-align:center"><div style="font-size:1.8em;font-weight:700">${t}</div><div style="font-size:14px;color:#666">总人数</div></div>
          <div class="student-card" style="text-align:center"><div style="font-size:1.8em;font-weight:700">${avg}</div><div style="font-size:14px;color:#666">平均分</div></div>
          <div class="student-card" style="text-align:center"><div style="font-size:1.8em;font-weight:700">${max}</div><div style="font-size:14px;color:#666">最高分</div></div>
          <div class="student-card" style="text-align:center"><div style="font-size:1.8em;font-weight:700">${min}</div><div style="font-size:14px;color:#666">最低分</div></div>
        </div>`);
    }

    /* ====== 重置全部 ====== */
    window.resetAll=()=>{
      if(!confirm('重置所有学生积分为 0？'))return;
      students.forEach(s=>{s.score=0;s.lastUp=new Date().toISOString()});
      render(); rank(); stats(); sync();
      toast('已重置');
    };

    /* ====== 同步 ====== */
    window.sync=async()=>{
      try{await save(); toast('已同步');}catch(err){toast('同步失败：'+err.message,'error')}
    };

    /* ====== 模态框 ====== */
    window.modalClose=()=>document.getElementById('modal').style.display='none';
    window.modalOk=()=>{modalClose();};

    /* ====== 提示 ====== */
    function toast(msg,type='success'){
      const bar=document.getElementById('status');
      bar.textContent=msg; bar.className='status-bar show '+type;
      setTimeout(()=>bar.classList.remove('show'),2500);
    }
  </script>
</body>
</html>
